<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>【文斌 & 静静】爱的小窝-我在这里</title>
<link rel="shortcut icon" href="/static/images/favicon.ico" type="image/x-icon" />
<link href="/static/css/style.css" rel="stylesheet" type="text/css">
<link href="/static/css/color.css" rel="stylesheet" type="text/css">
<link href="/static/css/bootstrap-responsive.css" rel="stylesheet" type="text/css">
<link href="/static/css/bootstrap.css" rel="stylesheet" type="text/css">
<link href="/static/css/countdown.css" rel="stylesheet" type="text/css">
<link href="/static/css/prettyPhoto.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/static/js/jquery-1.8.3.js"></script>
<script type="text/javascript" src="/static/js/mobile.js"></script>
<script type="text/javascript" src="/static/js/bootstrap.js"></script>
<script type="text/javascript" src="/static/js/jquery.countdown.js"></script>
<script type="text/javascript" src="/static/js/jquery.prettyPhoto.js"></script>
<script type="text/javascript" src="/static/js/lightbox.js"></script>
<script type="text/javascript" src="/static/js/custom.js"></script>
<script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=0LSHte0xuZrXWUrnkEDIIMfwlOnYfiTA"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
<style>
    img{
        max-width: none;
    }
</style>
</head>
	<body>

<!--Background Image-->
<img src="/static/images/bg.jpg" id="background"/>
<!--Background Image-->
<!--WRAPPTER START-->
<div class="wrapepr floral-bg">
	<!--header start-->
    <div class="header">
        <div class="clearfix"></div>
        <div class="container">
        <div class="couple-name">
            <div class="couple-name-holder">
                <div class="first-name resize">
                	<h1>刘文斌</h1>
                </div>
                <img src="/static/images/heart3.png" style="margin-left: 10px"/>
                <div class="last-name resize">
                    <h1>陈晓静</h1>
                </div>
            </div>
        </div>
        <div class="inner">
        <div class="getting-merried">
        	<p>爱的小窝</p>
        </div>
        </div>
      </div>
      </div>
      <div class="clearfix"></div>
    <!--header start-->
    <div class="content">
        <div class="inner">
            <!--navigation start-->
            <div class="navigation relative">
            	<span class="border1 resize">
                	<span class="border2"></span>
                </span>
                <ul id="nav">
                    <li><a href="/static/index.html">首页</a></li>
                    <li><a href="/static/travel.html">我们的旅程</a></li>
                    <li><a href="/static/memory.html">我们的回忆</a></li>
                    <li><a href="/static/gallery.html">我们的精彩</a></li>
                    <li><a href="/static/privity.html">我们的默契</a></li>
                    <li><a href="/static/location.html">我在这里</a></li>
                </ul>
            </div>
            <!--navigation end-->
            <div class="clearfix"></div>
            <!--content start-->
            <!--banners start-->
            	<div class="banner relative">
                	<img src="/static/images/banner-img.png" alt="">
                    <h2>我在这里</h2>
                	<div class="banner-pettern"></div>
                </div>
                <div class="clearfix"></div>
                <!--banners end-->
                <div class="top-borderline relative">
                	<div class="top-left-corner"><img src="/static/images/top-left-corner.png" alt=""></div>
                    <div class="top-right-corner"><img src="/static/images/top-right-corner.png" alt=""></div>
                </div>
            <div class="inner padding40px content-borders resize">
                <div class="btn-group" role="group" aria-label="...">
                  <button type="button" class="btn btn-default active">实时位置</button>
                  <a href="/static/track.html" type="button" class="btn btn-default" >历史路线</a>
                </div>
                <div class="btn-group" role="group" aria-label="..." style="margin-left: 10px">
                    <button id="refreshBtn" class="btn btn-default">刷新位置</button>
                    <button id="autoRefreshBtn" class="btn btn-primary">自动刷新</button>
                    <button id="locTongjiBtn" class="btn btn-info">位置统计</button>
                    <button id="notifyBtn" class="btn btn-info">消息通知</button>
                </div>
                <div id="tongji" class="alert alert-info" role="alert" style="margin-top: 10px;display:none"></div>
                <div id="notify" class="alert alert-info" role="alert" style="margin-top: 10px;display:none"></div>
                <hr style="margin: 5px 0"/>
                亲爱的，我在这里：
                <div id="locationMap" style="width: 100%;height:600px"></div>
                是否需要短信通知，当前状态：<button id="switch" class="btn btn-primary" style="display: none">是</button>（每天23:00到次日06:00为勿扰模式，不会收到短信哦<span id="slienceSpan"></span>）
                <div class="register" style="padding:1px 0"></div>
                <div class="clearfix"></div>
            </div>
            <!--content end-->
        </div>
     <!--FOOTER START-->
    <div class="footer relative">
        <div class="footer-leftside"></div>
        <div class="followus resize">
            <p>相爱是一种很完美的感觉，与你相识相知相爱成就了这种完美，我深爱你和感谢你！愿与你携手一生，相恋相伴相守一辈子！</p>
            <div class="clearfix"></div>
        </div>
    <div class="footer-rightside"></div>
    </div>
    <!--FOOTER START-->
    </div>
    <div class="clearfix"></div>
</div>
<script>
    var baiduIcon = new BMap.Icon('/static/images/mapheart.gif', new BMap.Size(20, 20), {
       anchor: new BMap.Size(12, 23)
    });
    var localIcon = new BMap.Icon('/static/images/mapheart.png', new BMap.Size(20, 20), {
       anchor: new BMap.Size(12, 23)
    });
    var commonPointIcon = new BMap.Icon('/static/images/commonPoint.png', new BMap.Size(20, 20), {
       anchor: new BMap.Size(12, 23)
    });
    var d = new Date();
    var date = d.getYear() + 1900 + "";
    if(d.getMonth() < 10){
        date += "0" + (d.getMonth() + 1)
    }else{
        date += "" + (d.getMonth() + 1)
    }
    if(d.getDate() < 10){
        date += "0" + d.getDate()
    }else{
        date += "" + d.getDate()
    }
    var map = new BMap.Map("locationMap");    // 创建Map实例
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 17);
	map.enableScrollWheelZoom(true);
	map.addControl(new BMap.NavigationControl());
	map.addControl(new BMap.MapTypeControl({
		mapTypes:[
            BMAP_NORMAL_MAP,
            BMAP_SATELLITE_MAP,
            BMAP_HYBRID_MAP
        ]})
    );
	getPoints();
	var currentPoint = null;
	function getPoints(){
	    $.ajax({
            url:"/getLastLocation",
            type:"POST",
            success:function(data){
                if(null != currentPoint){
                    map.removeOverlay(currentPoint);
                }
                var lon = data.lon;
                var lat = data.lat;
                var addr = data.addr;
                var desc = data.locationDescribe;
                var time = data.time;
                var dataSource = data.dataSource;
                var radius = data.radius;
                if("baidu" == dataSource){
                    currentPoint = new BMap.Marker(new BMap.Point(lon, lat),{icon:baiduIcon});
                }else{
                    currentPoint = new BMap.Marker(new BMap.Point(lon, lat),{icon:localIcon});
                }
                if(addr == undefined){
                    addr = "暂无位置信息，请刷新重试"
                }
                if(desc == undefined){
                    desc = "暂无位置信息"
                }
                //聚合使用
                map.addOverlay(currentPoint);
                currentPoint.addEventListener("click",function(){
                    var locationState = "";
                    if(radius * 1 >= 80){
                        locationState = "<p style='margin:0;line-height:1.5;font-size:13px;'>当前定位可能不太准确哦</p>";
                    }
                    var html = "<h4 style='margin:0 0 5px 0;padding:0.2em 0'>"+desc+"</h4>" +
                    "<p style='margin:0;line-height:1.5;font-size:13px;'>位置地点："+addr+"</p>" +
                    "<p style='margin:0;line-height:1.5;font-size:13px;'>更新时间："+time+"</p>" + locationState +
                    "</div>";
                    var infoWindow = new BMap.InfoWindow(html,{width:500,offset:new BMap.Size(0, -10)});
                    currentPoint.openInfoWindow(infoWindow);
                });
                map.panTo(new BMap.Point(lon, lat));
            }
        });
    }
    $("#refreshBtn").click(function(){
        getPoints();
    });
    var t = null;
	$("#autoRefreshBtn").click(function(){
        if($("#autoRefreshBtn").attr("class").indexOf("active") == -1){
            $("#autoRefreshBtn").addClass("active");
            $("#autoRefreshBtn").html("取消刷新");
            //当前为自动刷新
            t = setInterval(getPoints,10000);
        }else{
            $("#autoRefreshBtn").removeClass("active");
            $("#autoRefreshBtn").html("自动刷新");
            //当前为不自动刷新
            if(t != null){
                clearInterval(t)
            }
        }
    });
    $.ajax({
        url:"/visitLocationPageNotify",
        type:"POST",
        data:"type=p&page=l",
        success:function(data){
        }
    });
    $.ajax({
        url:"/getNeedNotify",
        type:"POST",
        success:function(data){
            $("#switch").show();
            var datas = data.split(":");
            data = datas[0];
            var slience = datas[1];
            if(data == 1){
                $("#switch").html("是");
            }else{
                $("#switch").html("否");
            }
            if(slience == 1){
                $("#slienceSpan").html("，当前为勿扰");
            }
        }
    });
    $("#switch").click(function(){
        var switchState = 0;
        if($("#switch").html() == "是"){
            $("#switch").html("否");
            switchState = 0;
        }else{
            $("#switch").html("是");
            switchState = 1;
        }
        $.ajax({
            url:"/updateNeedNotify",
            data:"isNeedNotify="+switchState,
            type:"POST",
            success:function(data){
            }
        });
    });
    var opt = {fillOpacity: 0.01,fillColor: "none",strokeStyle:"dashed",strokeColor:"blue", strokeWeight:5, strokeOpacity:0.5};
    $.ajax({
        url:"/getFence",
        type:"POST",
        success:function(data){
            var mh = data["小可爱的家"];
            var points = [];
            $.each(mh,function(i,n){
                n = n + "";
                points.push(new BMap.Point(n.split(",")[0] * 1,n.split(",")[1] * 1))
            });
            var polygon = new BMap.Polygon(points, opt);
            map.addOverlay(polygon);

            mh = data["小可爱的公司"];
            points = [];
            $.each(mh,function(i,n){
                n = n + "";
                points.push(new BMap.Point(n.split(",")[0] * 1,n.split(",")[1] * 1))
            });
            polygon = new BMap.Polygon(points, opt);
            map.addOverlay(polygon);

            mh = data["亲爱的家"];
            points = [];
            $.each(mh,function(i,n){
                n = n + "";
                points.push(new BMap.Point(n.split(",")[0] * 1,n.split(",")[1] * 1))
            });
            polygon = new BMap.Polygon(points, opt);
            map.addOverlay(polygon);
        }
    });
    var commonPoints = [];
    $("#locTongjiBtn").click(function(){
        if($("#tongji").css("display") == "none"){
            $.ajax({
                url:"/getLocationTongji",
                type:"POST",
                success:function(data){
                    $("#tongji").show();
                    $("#notify").hide();
                    var time = data["tongjiTime"];
                    time = time.split(" ")[1];
                    time = time.substr(0,time.length-3);
                    var html = "今天截止到"+time+"，我停留时间比较长的地点：<br>";
                    var index = 1;
                    $.each(data["data"],function(name,time){
                        var delayTime = operateTime(time[2] / 1000);
                        html += (index++)+". <b onclick='moveToPoint("+time[3]+","+time[4]+")'>"+name+"</b>，"+time[0]+"到"+time[1];
                        html += "，停留"+delayTime;
                        html += "<br>";

                        var p = new BMap.Marker(new BMap.Point(time[3], time[4]),{icon:commonPointIcon});
                        commonPoints.push(p);
                        map.addOverlay(p);
                        p.addEventListener("click",function(){
                            var html = "<h4 style='margin:0 0 5px 0;padding:0.2em 0'>停留时间长的地点："+name+"</h4>" +
                            "<p style='margin:0;line-height:1.5;font-size:13px;'>从"+time[0]+"到"+time[1]+"，停留"+delayTime+"</p>" +
                            "</div>";
                            var infoWindow = new BMap.InfoWindow(html,{width:300,offset:new BMap.Size(0, -10)});
                            p.openInfoWindow(infoWindow);
                        });
                    });
                    $("#tongji").html(html);
                }
            });
        }else{
            $("#tongji").hide();
            $("#notify").hide();
            for(var i = 0;i < commonPoints.length;i++){
                map.removeOverlay(commonPoints[i]);
            }
            commonPoints = [];
        }
    });
    $("#notifyBtn").click(function(){
        if($("#notify").css("display") == "none"){
            $.ajax({
                url:"/getFenceMessageByDate",
                data:"date="+date,
                type:"POST",
                success:function(data){
                    $("#tongji").hide();
                    $("#notify").show();
                    var html = "";
                    if(data.length != 0){
                        html += "今天收到了以下通知：<br/>";
                        var index = 1;
                        $.each(data,function(i,n){
                            html += (index++)+". "+n.messageTime+"，小可爱"+n.message;
                            html += "<br>";
                        });
                    }else{
                        html = "今天暂时没有收到通知"
                    }
                    $("#notify").html(html);
                }
            });
        }else{
            $("#tongji").hide();
            $("#notify").hide();
        }
    });
    function moveToPoint(lon,lat){
        map.panTo(new BMap.Point(lon, lat));
    }
    function operateTime(time){
        var result = "";
        var day = parseInt(time / 86400);
        if(0 != day){
            result += day + "天"
        }
        time = time - day * 86400;
        var hour = parseInt(time / (60 * 60))
        result += hour + "时";

        time = time - hour * (60 * 60);
        var min = parseInt(time / 60);
        result += min + "分";
        return result
    }
</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?18aa1da465cbe156fc3e7c413f9b2add";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html>
